<br/>

>[!WARNING|style: flat|label: 简要说明 ]
>
>- <span style='color:red'>(`IPolicyEvaluator`) 利用提取的授权策略 [ 完成最终的授权验证 ]</span>
>
>```csharp
>public interface IPolicyEvaluator
>{
>    
>       // [ A ] 请求认证 ( IAuthenticationHandler.AuthenticateAsync )
>       Task<AuthenticateResult> AuthenticateAsync(AuthorizationPolicy policy, HttpContext context);
>       // [ B ] 请求授权 ( IAuthorizationService.AuthorizeAsync )
>       Task<PolicyAuthorizationResult> AuthorizeAsync(AuthorizationPolicy policy, 
>                                                      AuthenticateResult authenticationResult, // [ A ]认证结果
>                                                      HttpContext context, object? resource);
>     
>}
>
>
>```
>
>
>
><br/>

<!-- tabs:start -->

#### **PolicyEvaluator**

```csharp
public class PolicyEvaluator : IPolicyEvaluator
{
    
      private readonly IAuthorizationService _authorization;
      public PolicyEvaluator(IAuthorizationService authorization)
          => _authorization = authorization;
 
      #region [ 认证 ] IAuthenticationHandler.AuthenticateAsync
      
      public virtual async Task<AuthenticateResult> AuthenticateAsync(AuthorizationPolicy policy, HttpContext context)
      {
           
            AuthenticateResult result = context.Features.Get<IAuthenticateResultFeature>()?.AuthenticateResult;
            if(result == null)
               result = AuthenticateResult.NoResult();
            return result;
            
      }
    
      #endregion
      #region [ 授权 ] IAuthorizationService.AuthorizeAsync
      
      public virtual async Task<PolicyAuthorizationResult> AuthorizeAsync(AuthorizationPolicy policy, 
                                                                          AuthenticateResult authenticationResult, 
                                                                          HttpContext context, 
                                                                          object? resource)
      {
          
            AuthorizationResult result = await this._authorization.AuthorizeAsync(context.User, resource, policy);
            // [ A ] 授权成功
            if (result.Succeeded)
               return PolicyAuthorizationResult.Success();

            // [ B ] 授权失败
            return (authenticationResult.Succeeded)
                   ? PolicyAuthorizationResult.Forbid(result.Failure) // 1. 认证成功: [ 质询拒绝 ] 无权访问 ( 状态码 403 )
                   : PolicyAuthorizationResult.Challenge();           // 2. 认证失败: [ 质询验证 ] 无效票据( 匿名请求/票据过期 )：状态码 401

      }
    
      #endregion
      
    
}


```



#### **[ 授权结果 ]PolicyAuthorizationResult**

```csharp
public class PolicyAuthorizationResult
{
      
     private static readonly PolicyAuthorizationResult _challengedResult = new() { Challenged = true };
     private static readonly PolicyAuthorizationResult _forbiddenResult = new() { Forbidden = true };
     private static readonly PolicyAuthorizationResult _succeededResult = new() { Succeeded = true };
    
     public bool Succeeded { get; private set; }
     public bool Forbidden { get; private set; }
     public bool Challenged { get; private set; }
    
     public static PolicyAuthorizationResult Challenge() => _challengedResult;
     public static PolicyAuthorizationResult Forbid() => _forbiddenResult;
     public static PolicyAuthorizationResult Success() => _succeededResult;
     
}


```





<!-- tabs:end -->



