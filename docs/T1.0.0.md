<br/>

```csharp
var builder = WebApplication.CreateBuilder(args);
// [ 注册 ] 请求认证
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
                .AddCookie(options =>
                 {
                      options.LoginPath = new PathString("/Login");
                      options.ExpireTimeSpan = TimeSpan.FromMinutes(30);
                      options.SlidingExpiration = true;

                 });
// [ 注册 ] 请求鉴权
builder.Services.AddAuthorization();
var app = builder.Build();
app.UseAuthentication();


```

```csharp
app.MapGet("/Login", (HttpContext context) =>
{

     // [ A ]用户身份
     var identity = new GenericIdentity("1001", "Password");
     var claims = new List<Claim>{
          new Claim(ClaimTypes.NameIdentifier, "372577325@qq.com", ClaimValueTypes.String,
                    ClaimsIdentity.DefaultIssuer,
                    ClaimsIdentity.DefaultIssuer,
                    identity),
     };
     identity.AddClaims(claims);
     // [ B ]用户标识
     GenericPrincipal principal = new GenericPrincipal(identity, ["admin"]);
     context.SignInAsync(principal, new AuthenticationProperties
     {
          RedirectUri = new PathString("/Home")
     });

});


```



```csharp
app.MapGet("/Home", async (ClaimsPrincipal? principal, HttpContext context) =>
{

      AuthorizationPolicy policy = new AuthorizationPolicyBuilder()
                                      .RequireAuthenticatedUser()   // [ 策略 ] 要求认证用户
                                      .RequireRole("admin","user")  // [ 策略 ] 指定角色
                                      .Build();

      IAuthorizationService authorizationService = context.RequestServices.GetRequiredService<IAuthorizationService>();
      AuthorizationResult authorizationResult = await authorizationService.AuthorizeAsync(principal,
                                                                                          context,
                                                                                          policy.Requirements);
      if (authorizationResult.Succeeded == false)
      {

           // [ 根据请求认证结果 -> 最终处理 ]
           AuthenticateResult AuthenticateResult = context.Features.Get<IAuthenticateResultFeature>()?.AuthenticateResult
                                                                                                    ?? AuthenticateResult.NoResult();
           if (AuthenticateResult.Succeeded)
               await context.ForbidAsync();    // [ 请求已认证 ] 质询拒绝: 无权访问 - 状态码 403
           else
               await context.ChallengeAsync(); // [ 请求未认证 ] 质询验证: 无效票据,匿名请求/票据过期 - 状态码 401 

      }
       
});


```





